ldap_server virtuagym {
  url ldap://ldap.virtuagym.com:389/dc=ldap,dc=virtuagym,dc=com?uid?sub?(objectClass=inetOrgPerson);

  group_attribute uniqueMember;
  group_attribute_is_dn on;

  satisfy any;
  require group "cn=administrator,ou=groups,dc=ldap,dc=virtuagym,dc=com";
  require group "cn=developer,ou=groups,dc=ldap,dc=virtuagym,dc=com";
  require group "cn=employee,ou=groups,dc=ldap,dc=virtuagym,dc=com";
}

server {
  listen [::]:80;
  listen 80;
  server_name vpn.digifit.in;

  location /.well-known/acme-challenge {
    default_type "text/plain";
    proxy_pass http://certs.digifit.in;
    include proxy_params;
  }

  location / {
    return 301 https://$server_name$request_uri;
  }
}

server {
  listen [::]:443;
  listen 443;

  server_name vpn.digifit.in;

  ssl on;
  ssl_certificate /etc/letsencrypt/live/vpn.digifit.in/fullchain.pem;
  ssl_certificate_key /etc/letsencrypt/live/vpn.digifit.in/privkey.pem;
  include h5bp/directive-only/ssl.conf;

  root /var/www;
  charset utf-8;
  add_header X-Upstream-Server {{ grains.id }};

  location / {
    satisfy any;
    proxy_pass https://{{ salt['grains.get']('public_ip') }}:943;
    include proxy_params;
   
    allow {{ salt['grains.get']('public_ip') }};
    deny  all;

    auth_ldap "Forbidden";
    auth_ldap_servers virtuagym;
  }
}
